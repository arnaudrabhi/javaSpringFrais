<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns="http://www.springframework.org/schema/webflow"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.springframework.org/schema/webflow
      http://www.springframework.org/schema/webflow/spring-webflow.xsd">

    <on-start>
        <evaluate expression="expenseDeclarationService.startNewDeclaration()"
                  result="flowScope.declaration"/>
    </on-start>

    <!-- Préparation de déclaration 1-->
    <view-state id="prepareDeclaration" view="flows/prepareDeclaration" >
        <transition on="nextStep" to="detailFormationStep"/>

        <!-- Menu de navigation -->
<!--        <transition on="goToPrepare" to="prepareDeclaration"/>-->
<!--        <transition on="goToFormation" to="detailFormationStep"/>-->
<!--        <transition on="goToTransport" to="TransportStep"/>-->
<!--        <transition on="goToAccommodation" to="AccommodationStep"/>-->
<!--        <transition on="goToMealExpenses" to="mealExpense"/>-->
<!--        <transition on="goToBankDetails" to="bankCoordinates"/>-->
<!--        <transition on="goToRecap" to="recapitulatifDeclaration"/>-->

    </view-state>

    <!-- Details de la formation 2-->
    <view-state id="detailFormationStep" view="flows/detaisFormation" model="declaration">

        <transition on="nextStep" to="TransportStep">
<!--            <evaluate expression="expenseDeclarationService.saveDeclaration(flowScope.declaration)" result="flowScope.declaration"/>-->
        </transition>

    </view-state>

    <!-- Details des dépenses liées au Transport 3-->
    <view-state id="TransportStep" view="flows/transport/transportExpenseMain">
        <transition on="addTransportExpense" to="addTransportExpense"/>
        <transition on="editTransportExpense" to="editTransportExpense">
            <set name="requestScope.transportExpenseId" value="requestParameters['transportExpenseId']"/>
        </transition>
        <transition on="submit" to="AccommodationStep"/>
    </view-state>

    <subflow-state id="addTransportExpense" subflow="addTransportFlow">
        <input name="declaration" value="flowScope.declaration" />
        <output name="declaration" value="flowScope.declaration" />
        <transition on="finish" to="TransportStep"/>
    </subflow-state>

    <subflow-state id="editTransportExpense" subflow="editTransportFlow">
        <input name="declaration" value="flowScope.declaration" />
        <input name="transportExpenseId" value="requestScope.transportExpenseId" />

        <output name="declaration" value="flowScope.declaration" />

    </subflow-state>

    <!-- Details des dépenses d'hébergement 4-->
    <view-state id="AccommodationStep" view="flows/accommodation/addAccommodationExpense">
        <on-entry>
            <evaluate expression="expenseDeclarationService.addAccommodationExpense(declaration)"/>
            <evaluate expression="declaration.getAccommodationExpense()" result="flowScope.accommodationExpense"/>
        </on-entry>

        <transition on="submit" to="mealExpense"/>
    </view-state>

    <view-state id="mealExpense" view="flows/meal/mealExpenseMain">
        <transition on="addMealExpense" to="addMealExpense"/>

        <transition on="submit" to="bankCoordinates"/>
    </view-state>


    <subflow-state id="addMealExpense" subflow="addMealFlow">
        <input name="declaration" value="flowScope.declaration" />

        <output name="declaration" value="flowScope.declaration" />
        <transition on="finish" to="mealExpense"/>

    </subflow-state>

    <!-- Details des dépenses liées à la restauration 5-->



    <view-state id="bankCoordinates">
        <transition on="submit" to="recapitulatifDeclaration"/>
    </view-state>


    <view-state id="recapitulatifDeclaration">
        <transition on="submit" to="end"/>
    </view-state>

    <end-state id="end" />

</flow>
